var app=angular.module("spt",["ui.bootstrap-slider","counter","ngMap"]);app.controller("dashboardController",["$scope","DashboardService","$filter","MapService","ChartService","baseURL","NgMap","$timeout",function(t,e,a,n,o,i,r,l){t.locationData,t.currentPage=1,t.totalPages=496,t.isAdmin=!1,t.filters={},t.showDetails=!1,t.googleMapsUrl="https://maps.googleapis.com/maps/api/js?key=AIzaSyD304cZovgQsVQt2vaAILBdD3bD5pFHcx0",t.ulbCords={NorthDMC:[28.6579034,77.182966],EDMC:[28.6387104,77.30824489999999],SDMC:[28.5730519,77.17353390000001],NDMC:[28.6281286,77.2155348],DC:[28.628716,77.162609],MCG:[28.4594965,77.0266383]},t.markerPosition=[28.7040592,77.10249019999999],t.gmap=!1,t.latcenter=28.7040592,t.longcenter=77.10249019999999,t.filterModel={ratings:[0,5],min:0,max:5,ward:"All Wards"!=t.selectedUlb?t.selectedUlb:"",type:"",period:"",fromDate:"",toDate:""},t.getData=function(a){a<1||a>t.totalPages||(t.currentPage=a,e.getData(a,t.filters).then(function(e){t.metaData=e.data,t.totalPages=Math.ceil(t.metaData.noOfElements/10),t.locationData=JSON.parse(t.metaData.content),t.pages=t.getPages(a,t.totalPages),console.log(e.data)}))},t.getNumbers=function(a,n){console.log(a),n&&(t.gmap=n,t.arrayUlbName=a.replace(/[\s]/g,""),t.selectedCenter=t.ulbCords[t.arrayUlbName],r.getMap().then(function(e){l(function(){google.maps.event.trigger(e,"resize"),t.latcenter=t.selectedCenter[0],t.longcenter=t.selectedCenter[1],t.$apply()},500)})),e.getNumbers(a,t.isAdmin).then(function(e){t.dashboardNumbers=e.data,t.totalToilets={myValue:0,myTarget:parseInt(t.dashboardNumbers.totalToilets)||1e3,myDuration:2e3,myEffect:"linear"},t.fourToFiveStarsRated={myValue:0,myTarget:parseInt(t.dashboardNumbers.fourToFiveStarsRated)||1e3,myDuration:2e3,myEffect:"linear"},t.threeOrLessStarsRated={myValue:0,myTarget:parseInt(t.dashboardNumbers.threeOrLessStarsRated)||1e3,myDuration:2e3,myEffect:"linear"},t.ulbList=JSON.parse(t.dashboardNumbers.ulbsList),t.selectedUlbIndex=t.ulbList.indexOf(a),t.selectedUlb=-1!=t.selectedUlbIndex?t.ulbList[t.selectedUlbIndex]:"All Wards",t.locationTypes=JSON.parse(t.dashboardNumbers.locationTypes),t.filters={ulbName:a||null},t.filterModel.ward=a||null,t.getData(1),t.isAdmin&&(t.ratingDistribution=JSON.parse(e.data.ratingDistribution),t.fiveStar=JSON.parse(t.ratingDistribution.fiveStar),t.fourStar=JSON.parse(t.ratingDistribution.fourStar),t.threeStar=JSON.parse(t.ratingDistribution.threeStar),t.twoStar=JSON.parse(t.ratingDistribution.twoStar),t.oneStar=JSON.parse(t.ratingDistribution.oneStar),t.noFeedBack=JSON.parse(t.ratingDistribution.noFeedBack),console.log(t.ratingDistribution))})},t.ratingData=function(t){},t.getPages=function(t,e){var a,n,o=[];t<=6?(a=1,n=10):t+4>=e?(a=e-9,n=e):(a=t-5,n=t+4),(a<1||n>e)&&(a=1,n=e);for(var i=a;i<=n;i++)o.push(i);return o},t.getPagination=function(t){return new Array(t)};var s=new Date;t.today=s.setDate(s.getDate()),t.yesterday=s.setDate(s.getDate()-1);var u=new Date;t.lastWeek=u.setDate(u.getDate()-6);var c=new Date;t.lastMonth=c.setDate(c.getDate()-30);var d=new Date;t.last2Week=c.setDate(d.getDate()-13),t.dateRange={today:[t.today,t.today],yesterday:[t.yesterday,t.yesterday],lastWeek:[t.today,t.lastWeek],last2Weeks:[t.today,t.last2Week],lastMonth:[t.today,t.lastMonth]},t.changePeriod=function(e){"custom"!=e&&""!=e&&(t.filterModel.fromDate=a("date")(t.dateRange[e][1],"dd-MM-yyyy"),t.filterModel.toDate=a("date")(t.dateRange[e][0],"dd-MM-yyyy")),""==e&&(t.filterModel.fromDate="",t.filterModel.toDate="")},t.filterModelCopy=angular.copy(t.filterModel),t.filterData=function(e,a){var n=a||!1;console.log(t.filterModel.ward),t.filters={page:1,minRating:""!=t.filterModel.ratings?t.filterModel.ratings[0]:0,maxRating:""!=t.filterModel.ratings?t.filterModel.ratings[1]:5,locationName:""!=t.filterModel.type?t.filterModel.type:null,ulbName:"All Wards"!=t.filterModel.ward||""!=t.filterModel.ward?t.filterModel.ward:null,sDate:""!=t.filterModel.fromDate?t.filterModel.fromDate:null,eDate:""!=t.filterModel.toDate?t.filterModel.toDate:null,download:n},console.log(t.filters),n?t.downloadReport():t.getData(1)},t.setFilters=function(e,a){t.filterModel.ratings=[e,e],t.filterModel.period="last2Weeks"==a?"custom":a,t.changePeriod(a),t.filterData(null,!1)},t.downloadReport=function(e){window.open(i+"download-report-of-locations/"+t.filters.minRating+"/"+t.filters.maxRating+"/"+t.filters.page+"/10/?locationType="+t.filters.locationName+"&startDate="+t.filters.sDate+"&endDate="+t.filters.eDate+"&ulbName="+t.filters.ulbName)},t.clearFilters=function(){t.filterModel=t.filterModelCopy},t.getReviews=function(a,n,o,i){i||$("#reviews").modal({show:!0}),e.getReviews(a,n,o).then(function(e){t.reviews=JSON.parse(e.data.content)})},t.showToiletDetails=function(a){t.toiletDetail=a,t.showDetails=!0,$("[href='#oRatings']").tab("show"),t.getReviews(a.location.id,0,5,!0),t.isAdmin&&e.getRatingData(t.toiletDetail.location.id).then(function(t){console.log(t);var e=JSON.parse(t.data.content),a=JSON.parse(t.data.overall),n=[],i=[],r=1;angular.forEach(e,function(t,e){n.push(e);for(var a={name:"",data:[]},o=JSON.parse(t),l=1;l<7;l++)a.data.push(o[l]),5==l&&r<6&&(a.name=r+" Stars",r++);i.push(a)}),o.getBarGraph(n,i),o.getPieChart(a)})},t.closeDetails=function(){t.showDetails=!1},t.init=function(e,a){t.isAdmin=!0,t.getNumbers(e),e||n.drawMap(t.getNumbers,t.gmap)}}]),app.constant("baseURL","http://72.52.82.130:80/api/").service("DashboardService",["$http","baseURL",function(t,e){this.getData=function(a,n){var o={page:1,minRating:0,maxRating:5,pageSize:10,locationName:null,ulbName:null,sDate:null,eDate:null,download:!1};angular.extend(o,n);var i;return i=o.download?"download-report-of-locations":"get-report-of-locations",t({method:"GET",url:e+i+"/"+o.minRating+"/"+o.maxRating+"/"+a+"/"+o.pageSize,params:{locationType:o.locationName,startDate:o.sDate,endDate:o.eDate,ulbName:o.ulbName}}).then(function(t){return t},function(t){console.log(t)})},this.getNumbers=function(a,n){var o=a||null;return t({method:"GET",url:n?e+"admin/get-dashboard":e+"get-dashboard",params:{ulbName:o}}).then(function(t){return t},function(t){console.log(t)})},this.getReviews=function(a,n,o){return t({method:"GET",url:e+"get-reviews-of-location/"+a+"/"+n+"/"+o}).then(function(t){return t},function(t){console.log(t)})},this.getRatingData=function(a){return t({method:"GET",url:e+"get-rating-counts-of-location/"+a}).then(function(t){return t},function(t){console.log(t)})},this.downloadReport=function(a){var n=ulbName||null;return t({method:"GET",url:e+"admin/get-dashboard",params:{ulbName:n}}).then(function(t){return t},function(t){console.log(t)})}}]).service("MapService",[function(){this.drawMap=function(t){Highcharts.geojson(Highcharts.maps["countries/in/custom/in-all-disputed"]);return Highcharts.mapChart("map",{chart:{},colors:["#9900CC","#9900CC"],title:{text:""},legend:{enabled:!1},subtitle:{text:"",floating:!0,align:"right",y:50,style:{fontSize:"16px"}},mapNavigation:{enabled:!0,buttonOptions:{verticalAlign:"bottom",align:"right"}},plotOptions:{series:{tooltip:{headerFormat:"",pointFormat:"{point.name}"}}},series:[{type:"map",data:[{name:"Delhi",path:"M982,-367L977,-391,948,-471,945,-486,945,-505,937,-530,924,-560,768,-700,755,-749,727,-786,748,-834,718,-909,627,-875,616,-875,590,-883,565,-894,476,-920,458,-920,442,-902,431,-886,395,-855,332,-859,282,-842,235,-815,215,-796,202,-770,198,-747,197,-718,203,-604,200,-570,203,-555,216,-531,223,-505,206,-480,173,-449,166,-430,161,-386,150,-373,132,-368,97,-363,76,-354,66,-342,47,-304,6,-263,0,-244,3,-228,18,-209,47,-181,58,-168,66,-155,69,-142,71,-133,76,-112,144,-131,252,-141,281,-146,295,-152,297,-180,308,-197,319,-202,332,-200,463,-133,473,-121,479,-109,500,-46,508,-31,521,-15,547,4,592,30,623,51,703,80,765,69,784,58,794,48,795,37,790,24,779,8,766,-4,760,-18,766,-34,797,-63,827,-83,852,-92,965,-113,918,-209,906,-223,913,-255,921,-270,932,-283,961,-310,973,-321,981,-334,984,-349,982,-367"}]},{type:"mappoint",name:"Delhi",marker:{fillColor:"white",lineColor:"black",lineWidth:1,radius:3},data:[{name:"NDMC- North Delhi Municipal Corporation",x:500,y:-700,total:500,star5:445,star3:342,ulbName:"North DMC"},{name:"EDMC- East Delhi Municipal Corporation",x:900,y:-500,total:500,star5:445,star3:342,ulbName:"EDMC"},{name:"SDMC- South Delhi Municipal Corporation",x:700,y:-250,total:500,star5:445,star3:342,ulbName:"SDMC"},{name:"NDMC- New Delhi Municipal Council",x:800,y:-350,total:500,star5:445,star3:342,ulbName:"NDMC"},{name:"Delhi Cantonment",x:500,y:-300,total:500,star5:445,star3:342,ulbName:"DC"},{name:"Faridabad",x:900,y:-50,total:500,star5:445,star3:342,ulbName:"NDMC"},{name:"Ghaziabad/Noida",x:1e3,y:-550,total:500,star5:445,star3:342,ulbName:"NDMC"},{name:"Gurugram",x:310,y:-50,total:500,star5:445,star3:342,ulbName:"MCG"}],events:{click:function(e){t(e.point.ulbName,!0)}}}],credits:{enabled:!1}})}}]).service("ChartService",[function(){this.getPieChart=function(t){return console.log(t),Highcharts.chart("pie-chart",{chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1,type:"pie"},title:{text:"Ratings"},tooltip:{pointFormat:"{series.name}: <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {point.percentage:.1f} %",style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"black"}}}},series:[{name:"share",colorByPoint:!0,data:[{name:"5 Stars",y:t[5],sliced:!0,selected:!0},{name:"4 Stars",y:t[4]},{name:"3 Stars",y:t[3]},{name:"2 Stars",y:t[2]},{name:"1 Stars",y:t[1]}]}],credits:{enabled:!1}})},this.getBarGraph=function(t,e){return Highcharts.chart("lastSixDays",{chart:{type:"column"},title:{text:"Last Six Days Ratings"},xAxis:{categories:t},yAxis:{min:0,title:{text:"Stars rated"}},tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> ({point.percentage:.0f}%)<br/>',shared:!0},plotOptions:{column:{stacking:"percent"}},series:e})}}]),function(t){"function"==typeof define&&define.amd?define(["bootstrap-slider","angular"],t):"object"==typeof module&&module.exports?module.exports=t(require("bootstrap-slider"),require("angular")):window&&t(window.Slider)}(function(t){angular.module("ui.bootstrap-slider",[]).directive("slider",["$parse","$timeout","$rootScope",function(e,a,n){return{restrict:"AE",replace:!0,template:'<div><input class="slider-input" type="text" style="width:100%" /></div>',require:"ngModel",scope:{max:"=",min:"=",step:"=",value:"=",ngModel:"=",ngDisabled:"=",range:"=",sliderid:"=",ticks:"=",ticksLabels:"=",ticksSnapBounds:"=",ticksPositions:"=",ticksTooltip:"=",scale:"=",focus:"=",rangeHighlights:"=",formatter:"&",onStartSlide:"&",onStopSlide:"&",onSlide:"&"},link:function(a,n,o,i,r){function l(){function r(t,e,a){p[t]=e||a}function l(t,e,a){p[t]=e||0===e?parseFloat(e):a}function c(t,e,a){p[t]=e?e+""=="true":a}function d(t){return angular.isString(t)&&0===t.indexOf("[")?angular.fromJson(t):t}var p={};r("id",a.sliderid),r("orientation",o.orientation,"horizontal"),r("selection",o.selection,"before"),r("handle",o.handle,"round"),r("tooltip",o.sliderTooltip||o.tooltip,"show"),r("tooltip_position",o.sliderTooltipPosition,"top"),r("tooltipseparator",o.tooltipseparator,":"),r("ticks",a.ticks),r("ticks_labels",a.ticksLabels),r("ticks_snap_bounds",a.ticksSnapBounds),r("ticks_positions",a.ticksPositions),r("ticks_tooltip",a.ticksTooltip,!1),r("rangeHighlights",a.rangeHighlights),r("scale",a.scale,"linear"),r("focus",a.focus),l("min",a.min,0),l("max",a.max,10),l("step",a.step,1);var f=p.step+"",g=f.search(/[^.,]*$/),m=f.substring(g);if(l("precision",o.precision,m.length),c("tooltip_split",o.tooltipsplit,!1),c("enabled",o.enabled,!0),c("naturalarrowkeys",o.naturalarrowkeys,!1),c("reversed",o.reversed,!1),c("range",a.range,!1),p.range){if(angular.isArray(a.value))p.value=a.value;else if(angular.isString(a.value)){if(p.value=d(a.value),!angular.isArray(p.value)){var h=parseFloat(a.value);isNaN(h)&&(h=5),h<a.min?(h=a.min,p.value=[h,p.max]):h>a.max?(h=a.max,p.value=[p.min,h]):p.value=[p.min,p.max]}}else p.value=[p.min,p.max];a.ngModel=p.value}else l("value",a.value,5);o.formatter&&(p.formatter=function(t){return a.formatter({value:t})}),void 0!==window.$&&"object"==typeof $.fn&&$.fn.slider&&($.fn.slider.constructor.prototype.disable=function(){this.picker.off()},$.fn.slider.constructor.prototype.enable=function(){this.picker.on()}),n[0].__slider&&n[0].__slider.destroy();var b=new t(n[0].getElementsByClassName("slider-input")[0],p);n[0].__slider=b;var D=d(o.updateevent);D=angular.isString(D)?[D]:["slide"],angular.forEach(D,function(t){b.on(t,function(t){i.$setViewValue(t)})}),b.on("change",function(t){i.$setViewValue(t.newValue)});var y={slideStart:"onStartSlide",slide:"onSlide",slideStop:"onStopSlide"};return angular.forEach(y,function(t,n){var i=e(o[t]);b.on(n,function(e){a[t]&&a.$apply(function(){i(a.$parent,{$event:e,value:e})})})}),angular.isFunction(u)&&(u(),u=null),u=a.$watch("ngDisabled",function(t){t?b.disable():b.enable()}),angular.isFunction(s)&&s(),s=a.$watch("ngModel",function(t){a.range?b.setValue(t):b.setValue(parseFloat(t)),b.relayout()},!0),b}var s,u,c=l(),d=["min","max","step","range","scale","ticksLabels","ticks","rangeHighlights"];angular.forEach(d,function(t){a.$watch(t,function(){c=l()})});var p=["relayout","refresh","resize"];angular.forEach(p,function(t){angular.isFunction(c[t])&&a.$on("slider:"+t,function(){c[t]()})})}}}])}),function(t){var e=function(){function e(){}return e.prototype.count=function(e,a,n,o,i,r,l,s){var u={};$(e).stop(!0,!0),e[a]=parseFloat(n||0),u[a]=parseFloat(o||0),e[a]!=u[a]&&$(e).animate(u,{duration:i,easing:r,step:l}).promise().done(function(){t.isFunction(s)&&s()})},e}(),a=function(){function e(t,e){this.restrict="EAC",this.scope={to:"=",value:"=",effect:"=?",duration:"=?",finish:"&?"},$counter=t,$timeout=e}return e.prototype.$inject=["$counter","$timeout"],e.prototype.link=function(e,a,n,o){var i={effect:"linear",duration:1e3};t.forEach(i,function(a,n){t.isDefined(e[n])||(e[n]=i[n])}),e.step=function(t){$timeout(function(){e.$apply(function(){e.value=t})})},e.$watch("to",function(){$counter.count(e,"value",e.value,e.to,e.duration,e.effect,e.step,e.finish)})},e}();t.module("counter",[]).service("$counter",function(){return new e}).directive("counter",["$counter","$timeout",function(t,e){return new a(t,e)}])}(window.angular);